@page "/{authorName}"
@model Chirp.Razor.Pages.UserTimelineModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
    string routeName = HttpContext.GetRouteValue("authorName")!.ToString() ?? "";
}

<div>
    
    <h2> @routeName's Timeline </h2>
    <p>
        Followers: @Model.Followers.Count() | Following: @Model.Following.Count()
        
    </p>
    @if (Model.IsCurrentAuthor(routeName)) {
        @if (Model.IsAuthenticated())
        {
            <div class="cheepbox">
                <h3>What's on your mind @(User.Identity!.Name)?</h3>
                (<span id="text-length-counter">0</span>/160)
                <form method="post">
                    <input style="float: left" asp-for="Text" oninput="updateLength()">
                    <input type="submit" value="Share">
                    @Html.AntiForgeryToken()
                </form>
            </div>

            <script>
                function updateLength() {
                    var counterBox = document.getElementById("text-length-counter");
                    var lengthOfInput = document.getElementById("Text").value.length;

                    counterBox.innerHTML = lengthOfInput;
                }
            </script>
        }
        else
        {
            <em>You need to <a asp-area="MicrosoftIdentity" asp-controller="Account" asp-action="SignIn">log in</a> to
                cheep.</em>
        }
    }

    @if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            @foreach (var cheep in Model.Cheeps)
            {
                <li>
					<a href="/@cheep.AuthorName"><img style="width:48px; height:48px" src="https://avatars.githubusercontent.com/@cheep.AuthorName"></a>
                    <p>
                        @if (!Model.IsCurrentAuthor(cheep.AuthorName))
                        {
                            @if (Model.Following.Contains(cheep.AuthorName)) 
                            {
                                <form method="post" asp-page-handler="Unfollow">
                                    <input type="hidden" name="authorName" value="@cheep.AuthorName" />
                                    <button type="submit" style="float: right">Unfollow</button>
                                </form>
                            } else if (Model.Followers.Contains(cheep.AuthorName)) 
                            {
                                <form method="post" asp-page-handler="Follow" >
                                    <input type="hidden" name="authorName" value="@cheep.AuthorName" />
                                    <button type="submit" style="float: right">Follow Back</button>
                                </form>
                            } else 
                            {
                                <form method="post" asp-page-handler="Follow">
                                    <input type="hidden" name="authorName" value="@cheep.AuthorName" />
                                    <button type="submit" style="float: right">Follow</button>
                                </form>
                            }
                        }
                        <strong>
                            <a href="/@cheep.AuthorName">@cheep.AuthorName</a>
                        </strong> 
                        <br/>
                        @cheep.Text
                        <small>&mdash; @cheep.TimeStamp</small>
                    </p>
                </li>
            }
        </ul>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }
    <div style="text-align: right">
        <a href="/@routeName?page=@Model.PreviousPage()">Previous page</a> |
        <a href="/@routeName?page=@Model.NextPage()">Next page</a>
    </div>
</div>
